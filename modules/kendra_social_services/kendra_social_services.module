<?php
/**
 * @file
 * Code for the Kendra Social Services feature.
 */

include_once('kendra_social_services.features.inc');

function kendra_social_services_services_resources() {
  $resources = array();
  $resources['profiles'] = array();  // stub for eventual profiles service
  $resources['smart_filters'] = array(); // stub for eventual smart_filters service
  $resources['content_items'] = array(); // stub for eventual content service
  $resources['social'] = array(
    'actions' => array(
      'connect' => array(
        'access arguments' => array('access content'),
        'callback' => '_kss_social_connect',
        'args' => array(
          array(
            'name' => 'network',
            'optional' => FALSE,
            'source' => array('data' => 'network'),
            'type' => 'string',
            'description' => 'The social network to connect to',
          ),
        ),
      ),
      'publish' => array(
        'access arguments' => array('access content'),
        'callback' => '_kss_social_publish', // stub for eventual social network publish service
        'args' => array(
          array(
            'name' => 'network',
            'optional' => FALSE,
            'source' => array('data' => 'network'),
            'type' => 'string',
            'description' => 'The social network to connect to',
          ),
          array(
            'name' => 'content',
            'optional' => FALSE,
            'source' => array('data' => 'content'),
            'type' => 'string',
            'description' => 'Content to post to social network',
          ),
        ),
      ),
    ),
  );
  return $resources;
}

function _kss_social_publish($network, $msg) {
	if ($network == 'facebook') {
	  $fbid = db_query("SELECT fbu FROM {fb_user} WHERE uid = :uid", 
	    array(':uid' => $user->uid))->fetchField();
		$access_token = db_query("SELECT session_key FROM {fb_user_app} WHERE fbu = :fbu", 
			array(':fbu' => $fbid))->fetchField();
		$fb_feed_url = "https://graph.facebook.com/$fbid/feed";

		$result = drupal_http_request($fb_feed_url, array(
		  'method' => 'POST',
		  'data' => "access_token={$access_token}&message={$msg}",
		));
  
	  watchdog('kss_social_publish', print_r($result, TRUE));
	  return $result->status_message;
	} else {
		return "Unknown Network";
	}
}

function _kss_social_connect($network) {
  if ($network == 'facebook') {
    $connect_url = url('connect', array('absolute' => TRUE));
    return array(
      'embed' => "<iframe src=\"{$connect_url}\" width=\"300px\" height=\"400px\" />",
    );
  }
  return "Kendra Social connect error: network unknown";
}

/** 
 * Define a callback that displays the registration/connect form
 */
function kendra_social_services_menu() {
  $items = array();
  $items['connect'] = array(
    'title' => 'Connect',
    'page callback' => '_kendra_social_services_connect',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );
  return $items;
}
function _kendra_social_services_connect() {
  return "<fb:login-button scope=\"\" v=\"2\">Connect</fb:login-button>";
  //$form = drupal_get_form('user_register_form');
  //print drupal_render($form);
}

