<?php

function _kss_annotation_retrieve($nid) {
	$annotate = node_load($nid);
	if (empty($annotate->nid)) {
		$annotate = taxonomy_term_load($nid);
	}
	return $annotate;
}

function _kss_annotation_delete($nid, $identifier) {
  global $user;

  // If data['identifier'] is set then we are deleting a tag.
  // if identifier is not set then we are deleting an annotation node
  if (!empty($identifier)) {
    $media = _kendra_saracen_trial_mod_lookup_id($identifier);
    $tid = $nid; // just to be clear this is a tag, not a node
    $tags = field_get_items('node', $media, 'field_mediaitem_tags');
    if (!empty($tags)) {
	    foreach ($tags as $key => $value) {
		    if ($value['tid'] == $tid) {
			    unset($tags[$key]);
		    }
	    }
    }
    $media->field_mediaitem_tags[LANGUAGE_NONE] = $tags;
    if ($user->uid == $media->uid) { 
      return array('status' => 'ok', 'message' => "deleted tag {$tid} from {$data['identifier']}");
    } else {
	    return array('status' => 'error', 'message' => 'permission denied, mediaitem');
    }
  }

  // else look for annotation node and unpublish:
	$annotate = node_load($nid);
	if (!empty($annotate->nid)) {
		if ($user->uid == $annotate->uid) {
			// unpublish the annotation. TODO: Should it be deleted?
			$annotate->status = 0;
			node_save($annotate);
			return array('status' => 'ok', 'message' => "deleted annotation {$nid}");
		} else {
			return array('status' => 'error', 'message' => 'permission denied, annotation');
		}
	}	
	return array('status' => 'error', 'message' => 'Invalid ID: Annotation does not exist or mediaitem identifier missing');
}


